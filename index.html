<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quản lý ảnh sản phẩm</title>
  <style>
    body{font-family:Segoe UI,Arial,sans-serif;margin:0;background:#f5f7fa;color:#333;overflow-y:auto;overflow-x:hidden;min-height:100vh}
    .topbar{background:#2c3e50;color:#fff;padding:12px 20px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:1000;box-shadow:0 2px 10px rgba(0,0,0,.1)}
    .topbar h1{margin:0;font-size:19px}
    .stats span{background:rgba(255,255,255,.2);padding:6px 14px;border-radius:20px;margin:0 6px;font-size:13px}
    .download{background:#3498db;padding:9px 18px;border-radius:6px;color:#fff;text-decoration:none;font-weight:bold}
    .container{max-width:1450px;margin:0 auto;padding:15px}
    #pagination{text-align:center;margin:20px 0}
    #pagination button,#pagination select{padding:8px 14px;margin:0 5px;border-radius:6px;border:1px solid #ddd;cursor:pointer}
    #pagination button:disabled{background:#eee;color:#999;cursor:not-allowed}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:22px}
    .card{background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 4px 15px rgba(0,0,0,.1);transition:.3s}
    .card:hover{transform:translateY(-5px)}
    .images-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:12px;background:#f8f9fa}
    .img-box{position:relative;border:2px dashed #bbb;border-radius:10px;height:170px;overflow:hidden;background:#fff;cursor:pointer;transition:.3s}
    .img-box:hover,.img-box.dragover{border-color:#27ae60;background:#d5f5e3}
    .img-box img{width:100%;height:100%;object-fit:cover}
    .placeholder{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;color:#777}
    .placeholder strong{display:block;color:#27ae60;font-size:16px}
    .img-label{position:absolute;top:8px;left:8px;background:rgba(0,0,0,.7);color:#fff;padding:3px 8px;border-radius:4px;font-size:11px}
    .remove-btn{position:absolute;top:8px;right:8px;background:#e74c3c;color:#fff;width:28px;height:28px;border-radius:50%;border:none;font-size:16px;cursor:pointer;z-index:5}
    .download-btn{position:absolute;bottom:8px;right:8px;background:rgba(0,0,0,0.6);color:#fff;padding:4px 8px;border-radius:4px;border:none;font-size:12px;cursor:pointer;z-index:5;opacity:0;transition:opacity .3s}
    .img-box:hover .download-btn{opacity:1}
    .download-btn:hover{background:rgba(0,0,0,0.8)}
    #global-loading{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.97);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:99999;opacity:0;pointer-events:none;transition:opacity .4s ease}
    #global-loading.active{opacity:1;pointer-events:auto}
    #global-loading .spinner{width:80px;height:80px;border:8px solid #f0f0f0;border-top:8px solid #27ae60;border-radius:50%;animation:spin 1s linear infinite;margin-bottom:20px}
    #global-loading .text{font-size:18px;font-weight:600;color:#27ae60;letter-spacing:1px}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    .info{padding:14px;text-align:center}
    .name{font-weight:bold;font-size:15px;margin-bottom:6px;color:#2c3e50}
    .status{padding:5px 12px;border-radius:20px;font-size:12px;font-weight:bold}
    .full{background:#d5f5e3;color:#27ae60}
    .lack{background:#fef9e7;color:#f39c12}
    .empty{background:#fadbd8;color:#e74c3c}
    .btn-copy{margin-top:8px;padding:8px 16px;background:#3498db;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:bold}
    #log-box{position:fixed;bottom:10px;right:10px;max-width:420px;background:#2c3e50;color:#fff;padding:12px;border-radius:8px;box-shadow:0 4px 15px rgba(0,0,0,.4);z-index:9999;font-size:13px;max-height:200px;overflow-y:auto;opacity:0;transition:opacity .4s}
    #log-box.show{opacity:1}
  </style>
</head>
<body>

<div id="global-loading">
  <div class="spinner"></div>
  <div class="text">Đang tải ảnh lên, vui lòng đợi...</div>
</div>

<div class="topbar">
  <h1>QUẢN LÝ ẢNH SẢN PHẨM</h1>
  <div class="stats">
    <span>Tổng: <strong id="total">0</strong></span>
    <span style="background:#27ae60">Đủ 4: <strong id="full">0</strong></span>
    <span style="background:#f39c12">Chưa đủ: <strong id="partial">0</strong></span>
    <span style="background:#e74c3c">Chưa có: <strong id="empty">0</strong></span>
    <a href="#" id="csv-download" class="download">TẢI CSV</a>
  </div>
</div>

<div id="pagination"></div>

<div class="container">
  <div class="grid" id="grid">Đang tải dữ liệu...</div>
</div>

<div id="log-box"></div>

<script>
// ================== CẤU HÌNH & LOCALSTORAGE ==================
const API_BASE = 'http://localhost:3000';

// Lấy từ localStorage (nếu có), không thì dùng mặc định
let currentPage = parseInt(localStorage.getItem('currentPage')) || 1;
let itemsPerPage = parseInt(localStorage.getItem('itemsPerPage')) || 24;

// Lưu vào localStorage mỗi khi thay đổi
function savePageState() {
  localStorage.setItem('currentPage', currentPage);
  localStorage.setItem('itemsPerPage', itemsPerPage);
}

// ================== HELPER ==================
function showLog(msg) {
  const box = document.getElementById('log-box');
  const line = document.createElement('div');
  line.textContent = msg;
  line.style.margin = '4px 0';
  box.appendChild(line);
  box.classList.add('show');
  setTimeout(() => {
    box.classList.remove('show');
    setTimeout(() => box.innerHTML = '', 1000);
  }, 4000);
}

async function compressImage(file) {
  const img = new Image();
  const url = URL.createObjectURL(file);
  img.src = url;
  await new Promise(r => img.onload = r);

  const MAX = 1200;
  let w = img.width, h = img.height;
  if (w > MAX || h > MAX) {
    if (w > h) { h = Math.round(h * MAX / w); w = MAX; }
    else { w = Math.round(w * MAX / h); h = MAX; }
  }

  const canvas = document.createElement('canvas');
  canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(img, 0, 0, w, h);
  URL.revokeObjectURL(url);

  return new Promise(resolve => {
    canvas.toBlob(blob => {
      resolve(new File([blob], file.name.replace(/\.[^/.]+$/, ".webp"), { type: 'image/webp' }));
    }, 'image/webp', 0.82);
  });
}

// ================== LOAD DATA (chỉ load trang hiện tại) ==================
async function load(page = currentPage) {
  currentPage = page;
  savePageState(); // lưu lại trang hiện tại

  const res = await fetch(`${API_BASE}/api/products?page=${currentPage}&limit=${itemsPerPage}`);
  const d = await res.json();

  // Cập nhật thống kê
  document.getElementById('total').textContent = d.stats.total;
  document.getElementById('full').textContent = d.stats.full;
  document.getElementById('partial').textContent = d.stats.partial;
  document.getElementById('empty').textContent = d.stats.empty;

  // Render danh sách sản phẩm
  document.getElementById('grid').innerHTML = d.products.map(p => {
    const c = p.images.filter(Boolean).length;
    return `<div class="card">
      <div class="images-grid">
        ${[0,1,2,3].map(i => `
          <div class="img-box" 
               ondrop="drop(event,'${p.id}',${i})"
               ondragover="allowDrop(event)"
               ondragleave="e=>e.currentTarget.classList.remove('dragover')"
               onclick="this.querySelector('input').click()">
            ${p.images[i] ? `
              <img src="${API_BASE}/${p.images[i]}">
              <button class="remove-btn" onclick="remove('${p.id}',${i},event)">X</button>
              <button class="download-btn" onclick="downloadImage('${API_BASE}/${p.images[i]}', '${p.slug}-${i+1}.webp', event)">Download</button>
            ` : `<div class="placeholder">Kéo thả<br><strong>Ảnh ${i+1}</strong></div>`}
            <div class="img-label">Ảnh ${i+1}</div>
            <input type="file" accept="image/*" style="display:none" onchange="upload(this.files[0],'${p.id}',${i})">
          </div>
        `).join('')}
      </div>
      <div class="info">
        <div class="name">${p.name}</div>
        <div class="status ${c===4?'full':c===0?'empty':'lack'}">${c===4?'Đủ 4':c===0?'Chưa có':c+'/4'}</div>
        <button class="btn-copy" onclick="copyPrompt('${p.id}')">Copy tên</button>
      </div>
    </div>`;
  }).join('');

  // Pagination
  document.getElementById('pagination').innerHTML = `
    <button onclick="load(${d.pagination.current-1})" ${d.pagination.current===1?'disabled':''}>Trước</button>
    <span>Trang ${d.pagination.current} / ${d.pagination.total}</span>
    <button onclick="load(${d.pagination.current+1})" ${d.pagination.current===d.pagination.total?'disabled':''}>Sau</button>
    <select onchange="itemsPerPage=this.value;currentPage=1;savePageState();load(1)">
      <option value="24" ${itemsPerPage==24?'selected':''}>24</option>
      <option value="50" ${itemsPerPage==50?'selected':''}>50</option>
      <option value="100" ${itemsPerPage==100?'selected':''}>100</option>
    </select>`;

  document.getElementById('csv-download').href = `${API_BASE}/download-csv`;
}

// Drag & drop
function allowDrop(e) {
  e.preventDefault();
  e.currentTarget.classList.add('dragover');
}

function downloadImage(url, filename, e) {
  e.stopPropagation();
  fetch(url).then(r => r.blob()).then(blob => {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
    showLog(`Đã tải: ${filename}`);
  });
}

// ================== UPLOAD & XÓA → CẬP NHẬT MÀ KHÔNG NHẢY TRANG ==================
async function upload(file, id, i) {
  if (!file) return;

  document.documentElement.style.overflow = 'hidden';
  document.getElementById('global-loading').classList.add('active');

  try {
    const compressed = await compressImage(file);
    const f = new FormData();
    f.append('image', compressed);

    const res = await fetch(`${API_BASE}/upload-single/${id}/${i}`, { method: 'POST', body: f });
    const json = await res.json();

    if (json.success) {
      const box = event.target.closest('.img-box');
      box.innerHTML = `
        <img src="${json.url}">
        <button class="remove-btn" onclick="remove('${id}',${i},event)">X</button>
        <button class="download-btn" onclick="downloadImage('${json.url}', '${json.url.split('/').pop()}', event)">Download</button>
        <div class="img-label">Ảnh ${i+1}</div>
        <input type="file" accept="image/*" style="display:none" onchange="upload(this.files[0],'${id}',${i})">
      `;
      showLog(json.log || `Đã upload ảnh ${i+1}`);
    } else {
      showLog('Lỗi upload ảnh ' + (i+1));
    }
  } catch (err) {
    console.error(err);
    showLog('Lỗi xử lý ảnh');
  } finally {
    document.getElementById('global-loading').classList.remove('active');
    document.documentElement.style.overflow = '';

    // CHỈ CẬP NHẬT LẠI TRANG HIỆN TẠI - KHÔNG NHẢY TRANG 1
    load(currentPage);
  }
}

async function remove(id, i, e) {
  e.stopPropagation();
  if (!confirm('Xóa ảnh này?')) return;

  await fetch(`${API_BASE}/remove-image/${id}/${i}`, { method: 'POST' });
  const box = e.target.closest('.img-box');
  box.innerHTML = `
    <div class="placeholder">Kéo thả<br><strong>Ảnh ${i+1}</strong></div>
    <div class="img-label">Ảnh ${i+1}</div>
    <input type="file" accept="image/*" style="display:none" onchange="upload(this.files[0],'${id}',${i})">
  `;
  showLog(`Đã xóa ảnh ${i+1}`);

  // Cập nhật lại trang hiện tại
  load(currentPage);
}

function drop(e, id, i) {
  e.preventDefault();
  e.currentTarget.classList.remove('dragover');
  const file = e.dataTransfer.files[0];
  if (file) upload(file, id, i);
}

function copyPrompt(id) {
  const name = document.querySelector(`[onclick*="'${id}'"]`)?.closest('.card')?.querySelector('.name')?.textContent || '';
  console.log("Copy tên sản phẩm:", name);
  navigator.clipboard.writeText(name);
  showLog('Đã copy tên sản phẩm');
}

// ================== KHỞI ĐỘNG ==================
load(currentPage); // Load đúng trang đã lưu
</script>
</body>
</html>