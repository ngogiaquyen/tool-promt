<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gấu Bông Shopee - Quản Lý Ảnh</title>
<style>
  body{margin:0;font-family:Segoe UI,sans-serif;background:#f8fcff;color:#2c3e50}
  .topbar{background:#3498db;color:#fff;padding:14px 20px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;box-shadow:0 4px 15px rgba(52,152,219,.2);flex-wrap:wrap;gap:10px}
  .topbar h1{margin:0;font-size:20px;font-weight:800}
  .stats{font-size:13px;display:flex;gap:12px;flex-wrap:wrap}
  .stats span{background:rgba(255,255,255,.25);padding:5px 12px;border-radius:20px;font-weight:bold}
  .pagination{text-align:center;margin:25px 0}
  .pagination button,.pagination select{padding:9px 18px;margin:0 6px;border:none;border-radius:10px;font-weight:bold;font-size:14px;cursor:pointer}
  .pagination button{background:#3498db;color:#fff}
  .pagination button:disabled{background:#95a5a6;cursor:not-allowed}
  .pagination select{background:#fff;color:#2980b9;border:2px solid #3498db}
  .container{max-width:1600px;margin:0 auto;padding:20px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(380px,1fr));gap:28px}
  .card{background:#fff;border-radius:18px;overflow:hidden;box-shadow:0 8px 25px rgba(52,152,219,.12);transition:.3s}
  .card:hover{transform:translateY(-8px);box-shadow:0 16px 40px rgba(52,152,219,.2)}
  .imgs{display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:18px;background:#ebf3fd}
  .box{position:relative;border:3px dashed #74b9ff;border-radius:14px;height:200px;background:#fff;overflow:hidden;cursor:pointer;transition:.2s}
  .box:hover{border-color:#0984e3;background:#dfeffc}
  .box img{width:100%;height:100%;object-fit:cover;border-radius:10px}
  .label{position:absolute;top:8px;left:8px;background:#3498db;color:#fff;padding:4px 10px;border-radius:8px;font-size:12px;font-weight:bold;z-index:2}
  .del,.download{position:absolute;top:8px;padding: 6px 8px;border-radius:12px;border:none;font-size:14px;cursor:pointer;z-index:10}
  .del{right:8px;background:#e74c3c;color:#fff}
  .del:hover{background:#c0392b}
  .download{right:46px;background:#2db3ed;color:#fff}
  .download:hover{background:#1e8449}
  .upload-area{width:100%;height:100%;position:absolute;inset:0;cursor:pointer;z-index:1}
  .btns{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
  .copy1{padding:11px;background:#3498db;color:#fff;border:none;border-radius:10px;font-size:12px;font-weight:bold;cursor:pointer;transition:.2s}
  .copy1:hover{background:#2980b9;transform:scale(1.05)}
  .info{padding:16px;text-align:center}
  .name{font-size:17px;font-weight:900;color:#2980b9;margin-bottom:6px}
  .status{padding:5px 14px;border-radius:20px;font-size:12px;font-weight:bold}
  .full{background:#d5f5e3;color:#27ae60}
  .lack{background:#fef9e7;color:#f39c12}
  .empty{background:#fadbd8;color:#e74c3c}
  #log{position:fixed;bottom:15px;right:15px;max-width:420px;background:#2980b9;color:#fff;padding:14px 18px;border-radius:12px;box-shadow:0 8px 30px rgba(41,128,185,.5);z-index:9999;font-size:13px;max-height:300px;overflow-y:auto;opacity:0;transition:opacity .4s;border:2px solid #74b9ff}
  #log.show{opacity:1}
</style>
</head>
<body>

<div class="topbar">
  <h1>GẤU BÔNG SHOPEE</h1>
  <div class="stats">
    <span>Tổng: <strong id="total">0</strong></span>
    <span style="background:#27ae60">Đủ 4: <strong id="full">0</strong></span>
    <span style="background:#f39c12">Chưa đủ: <strong id="partial">0</strong></span>
    <span style="background:#e74c3c">Chưa có: <strong id="empty">0</strong></span>
  </div>
</div>

<div class="pagination" id="pagination"></div>

<div class="container">
  <div class="grid" id="grid">Đang tải gấu bông...</div>
</div>

<div id="log"></div>

<script>
const API_BASE = 'http://localhost:3000';
let page = parseInt(localStorage.getItem('pg')||'1');
let limit = parseInt(localStorage.getItem('lim')||'24');
const cache = {};

// === 10 PROMPT PHỤ ĐẦY ĐỦ ===
const SUB_PROMPTS = [
  `Chụp góc nghiêng 45° bên phải gấu bông siêu dễ thương, ánh sáng studio đẹp lung linh, nền trắng tinh hoặc pastel nhẹ, độ phân giải 4K sắc nét tuyệt đối, nổi bật má phúng phính và tai cute, phong cách ảnh Shopee cao cấp.\nSản phẩm: {name}\nMàu sắc: {color}\nKích thước: {size}\nChi tiết: {desc}\nẢnh thật 100%, cực kỳ đáng yêu, khiến khách muốn mua ngay! PNG chất lượng cao nhất.`,

  `Chụp góc nghiêng 45° bên trái gấu bông, ánh sáng mềm mại từ bên hông, nền trắng tinh, 4K chi tiết cao, thấy rõ nơ xinh và khuôn mặt tròn xoe siêu dễ thương.\nSản phẩm: {name}\nMàu sắc: {color}\nKích thước: {size}\nChi tiết: {desc}\nẢnh thật 100%, tan chảy trái tim! PNG chất lượng cao nhất.`,

  `Chụp từ trên xuống gấu bông, thấy rõ tai, mắt, mũi và tay ôm nhau cực kỳ dễ thương, ánh sáng dịu nhẹ, nền trắng tinh, độ phân giải 4K sắc nét.\nSản phẩm: {name}\nMàu sắc: {color}\nKích thước: {size}\nChi tiết: {desc}\nẢnh thật 100%, đáng yêu không thể cưỡng lại! PNG chất lượng cao nhất.`,

  `Chụp góc sau lưng gấu bông, thấy rõ đuôi tròn xinh và lông bồng bềnh mềm mịn, ánh sáng đẹp, nền trắng/pastel, 4K chi tiết cao.\nSản phẩm: {name}\nMàu sắc: {color}\nKích thước: {size}\nChi tiết: {desc}\nẢnh thật 100%, dễ thương từ mọi góc nhìn! PNG chất lượng cao nhất.`,

  `Cận cảnh khuôn mặt gấu bông, mắt long lanh siêu tan chảy, mũi hồng, miệng cười dễ thương, ánh sáng hoàn hảo, nền trắng tinh, 4K sắc nét.\nSản phẩm: {name}\nMàu sắc: {color}\nKích thước: {size}\nChi tiết: {desc}\nẢnh thật 100%, ai nhìn cũng muốn ôm! PNG chất lượng cao nhất.`,

  `Gấu bông ngồi tự nhiên trên ghế sofa trắng, phong cách lifestyle ấm áp gần gũi, ánh sáng dịu nhẹ, nền trắng sạch, 4K chi tiết cao.\nSản phẩm: {name}\nMàu sắc: {color}\nKích thước: {size}\nChi tiết: {desc}\nẢnh thật 100%, rất hút khách! PNG chất lượng cao nhất.`,

  `Gấu bông nằm nghiêng dễ thương, tay che mắt hoặc ôm gối nhỏ, tư thế siêu đáng yêu, ánh sáng studio mềm mại, nền pastel nhẹ.\nSản phẩm: {name}\nMàu sắc: {color}\nKích thước: {size}\nChi tiết: {desc}\nẢnh thật 100%, tan chảy mọi trái tim! PNG chất lượng cao nhất.`,

  `Chụp góc cầm tay gấu bông như đang chơi đùa, thấy rõ lông mềm mịn, ánh sáng đẹp, nền trắng, 4K chi tiết từng sợi lông.\nSản phẩm: {name}\nMàu sắc: {color}\nKích thước: {size}\nChi tiết: {desc}\nẢnh thật 100%, khách sẽ muốn ôm ngay! PNG chất lượng cao nhất.`,

  `Cận cảnh chất liệu lông siêu mềm mượt, thấy từng sợi lông bồng bềnh, ánh sáng hoàn hảo, nền trắng tinh, 4K cực nét.\nSản phẩm: {name}\nMàu sắc: {color}\nKích thước: {size}\nChi tiết: {desc}\nẢnh thật 100%, chứng minh chất lượng cao cấp! PNG chất lượng cao nhất.`,

  `Chụp góc 3/4 nghiêng nhẹ gấu bông, ánh sáng thần thánh làm lông phát sáng lung linh, nền trắng tinh, 4K sắc nét, phong cách sang chảnh.\nSản phẩm: {name}\nMàu sắc: {color}\nKích thước: {size}\nChi tiết: {desc}\nẢnh thật 100%, đẹp như ảnh quốc tế! PNG chất lượng cao nhất.`
];

const MAIN_PROMPT = `Chụp ảnh chính diện gấu bông siêu dễ thương, góc thẳng đẹp lung linh, ánh sáng studio chuyên nghiệp mềm mại, nền trắng tinh khiết hoặc pastel nhẹ nhàng, độ phân giải 4K sắc nét tuyệt đối, lông bồng bềnh mềm mịn, mắt long lanh, tư thế hoàn hảo, phong cách ảnh bìa Shopee cực hút khách.\nSản phẩm: {name}\nMàu sắc: {color}\nKích thước: {size}\nChi tiết: {desc}\nẢnh phải thật 100%, dễ thương, bắt mắt, làm trẻ em và bố mẹ mê ngay từ cái nhìn đầu tiên!\nPNG, chất lượng cao nhất, không watermark.`;

function clean(t=''){return t?.replace(/<[^>]*>/g,'').replace(/\\r\\n|\\n|\\r/g,' ').replace(/\s+/g,' ').trim()||''}
function getColor(n,d){const c=['red','orange','yellow','green','blue','purple','pink','black','white','brown','gray','beige','gold','silver','cream','pastel'];const l=`${n} ${d}`.toLowerCase();for(let x of c)if(l.includes(x))return x[0].toUpperCase()+x.slice(1);return''}
function getSize(d){const m=d.match(/\b(\d+[\dx\.\s]*cm|xxs|xs|s|m|l|xl|xxl|small|medium|large|mini)\b/i);return m?m[0]:''}

function makePrompt(p, idx){
  const desc = clean(p.description || p.short_description || '');
  const data = {name:p.name||'', color:getColor(p.name,desc), size:getSize(desc), desc};
  const tmpl = idx === 0 ? MAIN_PROMPT : SUB_PROMPTS[Math.floor(Math.random()*SUB_PROMPTS.length)];
  return tmpl.replace('{name}',data.name).replace('{color}',data.color).replace('{size}',data.size).replace('{desc}',data.desc);
}

function copyPrompt(id, idx){
  const p = cache[id];
  if(!p) return log('Không tìm thấy sản phẩm!');
  const txt = makePrompt(p, idx);
  navigator.clipboard.writeText(txt).then(()=>log(`Đã copy prompt ảnh ${idx+1}`));
}

// TẢI ẢNH XUỐNG – MỚI THÊM
function downloadImage(url, productName, index){
  if(!url) return;
  const cleanName = productName.replace(/[^a-z0-9]/gi, '-').toLowerCase();
  const filename = `${cleanName}-${index+1}.webp`;
  fetch(API_BASE + url)
    .then(r => r.blob())
    .then(blob => {
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
      URL.revokeObjectURL(a.href);
      log(`Đã tải: ${filename}`);
    });
}

// UPLOAD ẢNH – ĐÚNG ROUTE BACKEND
async function upload(file, pid, idx){
  if(!file) return;
  const form = new FormData();
  form.append('image', file);
  const res = await fetch(`${API_BASE}/upload-single/${pid}/${idx}`, {
    method: 'POST',
    body: form
  });
  const json = await res.json();
  if(json.success) {
    log(`Upload thành công ảnh ${idx+1}: ${json.log || ''}`);
    load(page);
  } else {
    log('Upload thất bại: ' + (json.error || 'Lỗi không rõ'));
  }
}

// XÓA ẢNH – ĐÚNG ROUTE BACKEND + STOP PROPAGATION
function removeImg(pid, idx, e){
  e.stopPropagation();
  if(!confirm('Xóa ảnh này thật chứ?')) return;
  fetch(`${API_BASE}/remove-image/${pid}/${idx}`, {method:'POST'})
    .then(r=>r.json())
    .then(d=>{
      if(d.success) {
        log(`Đã xóa ảnh ${idx+1}`);
        load(page);
      }
    });
}

// DROP SUPPORT
function drop(e, pid, idx){
  e.preventDefault();
  const file = e.dataTransfer.files[0];
  if(file && file.type.startsWith('image/')) upload(file, pid, idx);
}

async function load(p=page){
  page = p;
  localStorage.setItem('pg',page); localStorage.setItem('lim',limit);
  const r = await fetch(`${API_BASE}/api/products?page=${page}&limit=${limit}`);
  const d = await r.json();
  d.products.forEach(x=>cache[x.id]=x);

  document.getElementById('total').textContent = d.stats.total;
  document.getElementById('full').textContent = d.stats.full;
  document.getElementById('partial').textContent = d.stats.partial;
  document.getElementById('empty').textContent = d.stats.empty;

  document.getElementById('grid').innerHTML = d.products.map(p=>{
    const c = p.images.filter(Boolean).length;
return `<div class="card" data-id="${p.id}">
      <div class="imgs">
        ${[0,1,2,3].map(i=>`
          <div class="box">
            ${p.images[i]?`
              <img src="${API_BASE}${p.images[i]}">
              <button class="del" onclick="removeImg('${p.id}',${i},event)">X</button>
              <button class="download" onclick="event.stopPropagation(); downloadImage('${p.images[i]}','${p.name.replace(/'/g,"\\\'")}',${i})">down</button>
            ` : `
              <div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#74b9ff;font-size:14px">
                <strong>Ảnh ${i+1}</strong><small>Kéo thả</small>
              </div>
            `}
            <div class="label">${i===0?'CHÍNH DIỆN':'Ảnh '+(i+1)}</div>
            <div class="upload-area" 
                 ondrop="drop(event, '${p.id}', ${i}); return false;" 
                  ondragover="event.preventDefault(); return false;"
                 onclick="this.parentElement.querySelector('input').click()"></div>
            <input type="file" accept="image/*" style="display:none" onchange="upload(this.files[0],'${p.id}',${i})">
          </div>
        `).join('')}
      </div>
      <div class="btns">
        <button class="copy1" onclick="copyPrompt('${p.id}',0)">Copy Ảnh 1</button>
        <button class="copy1" onclick="copyPrompt('${p.id}',1)">Copy Ảnh 2</button>
        <button class="copy1" onclick="copyPrompt('${p.id}',2)">Copy Ảnh 3</button>
        <button class="copy1" onclick="copyPrompt('${p.id}',3)">Copy Ảnh 4</button>
      </div>
      <div class="info">
        <div class="name">${p.name}</div>
        <div class="status ${c===4?'full':c===0?'empty':'lack'}">${c===4?'Đủ 4':c===0?'Chưa có':c+'/4'}</div>
      </div>
    </div>`;
  }).join('');

  const pg = d.pagination;
  document.getElementById('pagination').innerHTML = `
    <button onclick="load(${pg.current-1})" ${pg.current===1?'disabled':''}>Trước</button>
    <span style="font-weight:bold;color:#2980b9;margin:0 15px">Trang ${pg.current} / ${pg.total}</span>
    <button onclick="load(${pg.current+1})" ${pg.current===pg.total?'disabled':''}>Sau</button>
    <select onchange="limit=this.value;load(1)">
      <option value="24" ${limit==24?'selected':''}>24</option>
      <option value="50" ${limit==50?'selected':''}>50</option>
      <option value="100" ${limit==100?'selected':''}>100</option>
    </select>`;
}

function log(m){
  const b=document.getElementById('log');
  const d=document.createElement('div');d.textContent=m;d.style.margin='6px 0';
  b.prepend(d);b.classList.add('show');
  setTimeout(()=>{b.classList.remove('show');setTimeout(()=>b.innerHTML='',1000)},4000);
}

load();
</script>
</body>
</html>